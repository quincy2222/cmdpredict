<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CMDpredict â€” Internal Prediction Market</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231B8A9E'/><text x='50' y='68' font-family='monospace' font-size='45' font-weight='bold' fill='white' text-anchor='middle'>CM</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--t:#1B8A9E;--td:#156F80;--tl:#E8F6F8;--tll:#F3FAFB;--gn:#10B981;--rd:#EF4444;--bg:#F5F7FA;--card:#fff;--bdr:#E2E8F0;--tx:#1a2332;--tx2:#64748B;--tx3:#94A3B8}
body{background:var(--bg);font-family:'Source Sans 3','Segoe UI',sans-serif;color:var(--tx);-webkit-font-smoothing:antialiased;min-height:100vh}
.m{font-family:'IBM Plex Mono',monospace}
@keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes sr{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:translateX(0)}}
@keyframes ns{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:10px;padding:18px;cursor:pointer;transition:all .18s;animation:fu .3s ease both}
.card:hover{border-color:var(--t);box-shadow:0 3px 14px rgba(27,138,158,.08);transform:translateY(-1px)}
.btn{border:none;border-radius:6px;padding:9px 16px;font-family:'Source Sans 3',sans-serif;font-weight:600;font-size:13px;cursor:pointer;transition:all .1s}
.btn:active{transform:scale(.97)}
.btn-t{background:var(--t);color:#fff}.btn-t:hover{background:var(--td)}
.btn-ghost{background:transparent;border:1px solid var(--bdr);color:var(--tx2);font-size:12px;padding:6px 12px}
.btn-ghost:hover{border-color:var(--tx3);color:var(--tx)}
.btn-danger{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:var(--rd);font-size:12px;padding:6px 12px}
.btn-danger:hover{background:rgba(239,68,68,.15)}
input,textarea,select{background:#fff;border:1px solid #D1D9E6;border-radius:6px;padding:9px 12px;color:var(--tx);font-family:'Source Sans 3',sans-serif;font-size:13.5px;outline:none;transition:border .15s;width:100%}
input:focus,textarea:focus,select:focus{border-color:var(--t);box-shadow:0 0 0 3px rgba(27,138,158,.08)}
.pill{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;letter-spacing:.4px;text-transform:uppercase}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(2px)}
.modal{background:#fff;border:1px solid var(--bdr);border-radius:14px;max-width:600px;width:95%;max-height:92vh;overflow-y:auto;padding:26px;animation:sr .2s ease;box-shadow:0 16px 48px rgba(0,0,0,.1)}
.modal-lg{max-width:700px}
.notif{position:fixed;top:14px;right:14px;z-index:200;padding:10px 16px;border-radius:7px;font-weight:500;font-size:13px;animation:ns .2s ease;box-shadow:0 4px 16px rgba(0,0,0,.12);border-left:3px solid;background:#fff}
.tab{padding:5px 12px;border-radius:5px;cursor:pointer;font-size:13px;font-weight:500;color:var(--tx3);transition:all .1s;background:transparent;border:none;font-family:'Source Sans 3',sans-serif}
.tab:hover{color:var(--tx2)}.tab.active{background:var(--tl);color:var(--t);font-weight:600}
.xbtn{background:#F1F5F9;border:none;border-radius:6px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--tx2);font-size:16px;flex-shrink:0}
.xbtn:hover{background:#E2E8F0}
.stat-card{background:var(--card);border:1px solid var(--bdr);border-radius:8px;padding:12px 14px}
.stat-label{font-size:9.5px;color:var(--tx3);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.live-dot{width:7px;height:7px;border-radius:50%;background:var(--gn);display:inline-block;animation:pulse 2s infinite;margin-right:4px}
.resolved-badge{background:#DCFCE7;color:#166534;padding:3px 10px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.cancelled-badge{background:#FEF3C7;color:#92400E;padding:3px 10px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
header{border-bottom:1px solid var(--bdr);background:#fff;position:sticky;top:0;z-index:50}
.hdr-inner{max-width:1080px;margin:0 auto;padding:0 22px;display:flex;align-items:center;justify-content:space-between;height:52px}
main{max-width:1080px;margin:0 auto;padding:20px 22px}
footer{border-top:1px solid var(--bdr);padding:12px 22px;margin-top:30px;display:flex;justify-content:center;align-items:center;gap:12px;font-size:10.5px;color:var(--tx3);background:#fff}
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
.market-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:12px}
.port-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:22px}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:#D1D9E6;border-radius:2px}
.user-row{display:grid;grid-template-columns:1fr 100px 110px 140px;padding:12px 14px;border-bottom:1px solid #F1F5F9;align-items:center;cursor:pointer;transition:background .1s}
.user-row:hover{background:var(--tll)}
.user-row-admin{grid-template-columns:1fr 100px 110px 200px}
.activity-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;border-bottom:1px solid #F1F5F9;font-size:12.5px}
.activity-row:last-child{border-bottom:none}
.editable-balance{background:transparent;border:1px solid transparent;border-radius:4px;padding:2px 6px;font-family:'IBM Plex Mono',monospace;font-size:13px;font-weight:600;text-align:right;width:90px;cursor:pointer;transition:all .15s}
.editable-balance:hover{border-color:#D1D9E6;background:#F8FAFC}
.editable-balance:focus{border-color:var(--t);background:#fff;box-shadow:0 0 0 3px rgba(27,138,158,.08);cursor:text}
@media(max-width:700px){.stats-grid{grid-template-columns:repeat(2,1fr)}.port-grid{grid-template-columns:1fr}.market-grid{grid-template-columns:1fr}.hdr-inner{padding:0 12px;height:auto;flex-wrap:wrap;padding-top:6px;padding-bottom:6px}main{padding:14px 12px}.user-row,.user-row-admin{grid-template-columns:1fr 70px 70px auto;font-size:12px}}
.setup-screen{min-height:100vh;background:var(--bg);display:flex;align-items:center;justify-content:center}
.setup-box{background:#fff;border-radius:16px;padding:36px;max-width:440px;width:92%;text-align:center;box-shadow:0 8px 40px rgba(0,0,0,.06);animation:fu .4s ease}
</style>
</head>
<body>
<div id="app"></div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CMDpredict v4 â€” Activity ledger, user profiles, admin CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ADMINS=["quincy m.","quincy mcdougal","admin"];
const CATS=["All","Meetings","Shipping","Hiring","Culture","Metrics","Finance","Engineering","Product","Other"];
const CI={Meetings:"ğŸ“…",Shipping:"ğŸš€",Hiring:"ğŸ‘¥",Culture:"ğŸ¯",Metrics:"ğŸ“Š",Finance:"ğŸ’°",Engineering:"âš™ï¸",Product:"ğŸ“¦",Other:"ğŸ”®"};
const T="#1B8A9E",TD="#156F80",TL="#E8F6F8",GN="#10B981",RD="#EF4444";

const FIREBASE_CONFIG={
  apiKey:"AIzaSyDra0iY_fPwjdgAPWf-JQr8H6ETmUQUaMg",
  authDomain:"cmdpredict.firebaseapp.com",
  databaseURL:"https://cmdpredict-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"cmdpredict",
  storageBucket:"cmdpredict.firebasestorage.app",
  messagingSenderId:"1084863694257",
  appId:"1:1084863694257:web:7bbb348da2e5deb5eb2990",
  measurementId:"G-CTXJ4M7FYC"
};

let db=null,useFirebase=false;
try{if(FIREBASE_CONFIG.apiKey){firebase.initializeApp(FIREBASE_CONFIG);db=firebase.database();useFirebase=true}}catch(e){console.warn("FB fail",e)}

// â”€â”€ STATE â”€â”€
let S={
  markets:[],trades:[],users:{},
  portfolio:{balance:10000,positions:[]},
  name:localStorage.getItem('cmdp_name')||'',nameIn:'',
  view:'markets',cat:'All',sort:'newest',q:'',
  sel:null,selOc:0,side:'yes',amt:'',
  creating:false,editing:null,resolving:null,adminPanel:false,
  addFundsUser:null,addFundsAmt:'',
  // User profile modal (visible to everyone)
  viewingUser:null,
  // Admin: add new user modal
  addingUser:false,newUserName:'',newUserBalance:'10000',
  // Admin: editing balance inline
  editingBalance:null,editBalanceVal:'',
  notif:null,
  form:{title:'',desc:'',cat:'Other',end:'',outcomes:['Yes','No']},
  editForm:{outcomes:[]},
  ready:false,renderCount:0
};

function isAdmin(){return ADMINS.some(a=>a.toLowerCase()===S.name.toLowerCase())}

// â”€â”€ FIREBASE INIT â”€â”€
async function init(){
  if(useFirebase){
    db.ref('markets').on('value',snap=>{
      const v=snap.val();S.markets=v?Object.values(v):[];
      if(S.sel){const f=S.markets.find(m=>m.id===S.sel.id);if(f)S.sel=f}
      render();
    });
    db.ref('trades').on('value',snap=>{
      const v=snap.val();S.trades=v?Object.values(v):[];render();
    });
    db.ref('users').on('value',snap=>{
      const v=snap.val();S.users=v||{};render();
    });
  }else{
    S.markets=JSON.parse(localStorage.getItem('cmdp_markets')||'[]');
    S.trades=JSON.parse(localStorage.getItem('cmdp_trades')||'[]');
    S.users=JSON.parse(localStorage.getItem('cmdp_users')||'{}');
  }
  const rp=localStorage.getItem('cmdp_portfolio');if(rp)S.portfolio=JSON.parse(rp);
  S.ready=true;render();
}

function saveMarkets(m){if(useFirebase){const o={};m.forEach(x=>{o[x.id]=x});db.ref('markets').set(o)}else localStorage.setItem('cmdp_markets',JSON.stringify(m))}
function saveTrade(t){if(useFirebase)db.ref('trades/'+t.id).set(t);else{const a=JSON.parse(localStorage.getItem('cmdp_trades')||'[]');a.push(t);localStorage.setItem('cmdp_trades',JSON.stringify(a))}}
function savePortfolio(){
  localStorage.setItem('cmdp_portfolio',JSON.stringify(S.portfolio));
  const u=S.users[encodeKey(S.name)]||S.users[S.name]||{};
  u.name=S.name;u.balance=S.portfolio.balance;u.lastSeen=Date.now();
  if(useFirebase)db.ref('users/'+encodeKey(S.name)).set(u);
  else{S.users[encodeKey(S.name)]=u;localStorage.setItem('cmdp_users',JSON.stringify(S.users))}
}
function encodeKey(k){return k.replace(/[.#$\/\[\]]/g,'_')}
function flash(msg,type='ok'){S.notif={msg,type};render();setTimeout(()=>{S.notif=null;render()},3200)}

// â”€â”€ ACTIVITY LEDGER â”€â”€
// Every significant action is logged to the activity ledger in Firebase/localStorage
function logActivity(entry){
  const a={id:Date.now()+'_'+Math.random().toString(36).slice(2,6),ts:Date.now(),...entry};
  if(useFirebase){
    db.ref('activity/'+a.id).set(a);
  }else{
    const acts=JSON.parse(localStorage.getItem('cmdp_activity')||'[]');
    acts.push(a);
    localStorage.setItem('cmdp_activity',JSON.stringify(acts));
  }
}

// Load activity log
let activityLog=[];
function initActivityLog(){
  if(useFirebase){
    db.ref('activity').on('value',snap=>{
      const v=snap.val();activityLog=v?Object.values(v):[];
      activityLog.sort((a,b)=>b.ts-a.ts);
    });
  }else{
    activityLog=JSON.parse(localStorage.getItem('cmdp_activity')||'[]');
    activityLog.sort((a,b)=>b.ts-a.ts);
  }
}

// â”€â”€ Get user stats from trades â”€â”€
function getUserStats(userName){
  const userTrades=S.trades.filter(t=>t.who===userName);
  let totalVolume=0,totalPnl=0,wins=0,losses=0;
  const tradeDetails=[];

  userTrades.forEach(t=>{
    totalVolume+=(t.amount||0);
    const mk=S.markets.find(m=>m.id===t.mid);
    let cur=t.avg,pnl=0,status='open';
    if(mk&&mk.outcomes[t.outcomeIdx]){
      if(mk.resolved){
        const won=(t.side==='yes'&&t.outcomeIdx===mk.winnerIdx)||(t.side==='no'&&t.outcomeIdx!==mk.winnerIdx);
        if(mk.cancelled){
          pnl=0;status='cancelled';
        }else if(won){
          pnl=t.shares-t.amount;wins++;status='won';
        }else{
          pnl=-t.amount;losses++;status='lost';
        }
      }else{
        cur=t.side==='yes'?mk.outcomes[t.outcomeIdx].price:(1-mk.outcomes[t.outcomeIdx].price);
        pnl=(cur-t.avg)*t.shares;
        status='open';
      }
    }
    totalPnl+=pnl;
    tradeDetails.push({...t,currentPrice:cur,pnl,status,marketTitle:t.title||mk?.title||'Unknown'});
  });

  tradeDetails.sort((a,b)=>b.ts-a.ts);
  return{trades:tradeDetails,totalVolume,totalPnl,wins,losses,totalTrades:userTrades.length};
}

// â”€â”€ CPMM â”€â”€
function cpmmBuy(market,oi,side,amount){
  const m=JSON.parse(JSON.stringify(market)),k=0.04;
  if(side==='yes')m.outcomes[oi].pool=(m.outcomes[oi].pool||100)+amount*k;
  else m.outcomes[oi].pool=Math.max(5,(m.outcomes[oi].pool||100)-amount*k);
  const tp=m.outcomes.reduce((s,o)=>s+(o.pool||100),0);
  m.outcomes.forEach(o=>{o.price=Math.max(.01,Math.min(.99,Math.round(((o.pool||100)/tp)*100)/100));o.history=[...(o.history||[o.price]),o.price]});
  const ps=m.outcomes.reduce((s,o)=>s+o.price,0);
  m.outcomes.forEach(o=>{o.price=Math.round((o.price/ps)*100)/100});
  m.volume=(m.volume||0)+amount;m.traders=(m.traders||0)+1;
  return m;
}

// â”€â”€ ACTIONS â”€â”€
function confirmName(){
  if(!S.nameIn.trim())return;S.name=S.nameIn.trim();localStorage.setItem('cmdp_name',S.name);
  savePortfolio();
  logActivity({type:'join',user:S.name,desc:`${S.name} joined CMDpredict`});
  render();
}

function createMarket(){
  const f=S.form;
  if(!f.title||!f.end){flash("Title and end date required","err");return}
  const labels=f.outcomes.filter(o=>o.trim());
  if(labels.length<2){flash("Need at least 2 outcomes","err");return}
  const ip=Math.round((1/labels.length)*100)/100;
  const m={id:Date.now(),title:f.title,description:f.desc||"No resolution criteria specified.",category:f.cat,endDate:f.end,creator:S.name,
    outcomes:labels.map(l=>({label:l,price:ip,pool:100,history:[ip]})),
    volume:0,liquidity:1000,traders:0,resolved:false,winnerIdx:null,createdAt:new Date().toISOString()};
  S.markets=[m,...S.markets];saveMarkets(S.markets);
  logActivity({type:'market_created',user:S.name,marketId:m.id,desc:`${S.name} created market: "${f.title}"`});
  S.creating=false;S.form={title:'',desc:'',cat:'Other',end:'',outcomes:['Yes','No']};
  flash("Market created!");
}

function trade(){
  const a=parseFloat(S.amt);
  if(!a||a<=0){flash("Enter a valid amount","err");return}
  if(a>S.portfolio.balance){flash("Insufficient balance","err");return}
  if(S.sel.resolved){flash("Market is resolved","err");return}
  const oc=S.sel.outcomes[S.selOc],price=S.side==='yes'?oc.price:(1-oc.price);
  const shares=Math.round((a/price)*100)/100;
  const updated=cpmmBuy(S.sel,S.selOc,S.side,a);
  const rec={id:Date.now(),mid:S.sel.id,outcomeIdx:S.selOc,outcomeLabel:oc.label,
    side:S.side,shares,avg:price,title:S.sel.title,who:S.name,amount:a,ts:Date.now()};
  saveTrade(rec);
  S.portfolio.balance=Math.round((S.portfolio.balance-a)*100)/100;
  S.portfolio.positions.push(rec);savePortfolio();
  S.markets=S.markets.map(m=>m.id!==S.sel.id?m:updated);saveMarkets(S.markets);
  S.sel=updated;S.amt='';
  logActivity({type:'trade',user:S.name,marketId:S.sel.id,amount:a,side:S.side,outcome:oc.label,
    desc:`${S.name} bought ${shares} ${S.side.toUpperCase()} "${oc.label}" at ${Math.round(price*100)}Â¢ for $${a}`});
  flash(`Bought ${shares} ${S.side.toUpperCase()} "${oc.label}" at ${Math.round(price*100)}Â¢`);
}

function saveEdit(){
  const ef=S.editForm,labels=ef.outcomes.filter(o=>o.trim());
  if(labels.length<2){flash("Need at least 2 outcomes","err");return}
  const m=S.markets.find(x=>x.id===S.editing.id);if(!m)return;
  const u=JSON.parse(JSON.stringify(m));
  u.outcomes=labels.map(label=>{
    const ex=u.outcomes.find(o=>o.label===label);
    if(ex)return ex;
    return{label,price:1/labels.length,pool:100,history:[1/labels.length]};
  });
  const tp=u.outcomes.reduce((s,o)=>s+(o.pool||100),0);
  u.outcomes.forEach(o=>{o.price=Math.max(.01,Math.round(((o.pool||100)/tp)*100)/100)});
  const ps=u.outcomes.reduce((s,o)=>s+o.price,0);
  u.outcomes.forEach(o=>{o.price=Math.round((o.price/ps)*100)/100});
  if(ef.title)u.title=ef.title;if(ef.desc)u.description=ef.desc;if(ef.end)u.endDate=ef.end;
  S.markets=S.markets.map(x=>x.id===u.id?u:x);saveMarkets(S.markets);
  S.editing=null;S.sel=u;flash("Market updated!");
}

// â”€â”€ RESOLVE WITH PAYOUT â”€â”€
function resolveMarket(winnerIdx){
  const m=S.markets.find(x=>x.id===S.resolving.id);if(!m)return;
  const u=JSON.parse(JSON.stringify(m));
  u.resolved=true;u.winnerIdx=winnerIdx;u.resolvedAt=new Date().toISOString();u.resolvedBy=S.name;
  u.outcomes.forEach((o,i)=>{o.price=i===winnerIdx?1:0;o.history=[...(o.history||[]),o.price]});
  S.markets=S.markets.map(x=>x.id===u.id?u:x);saveMarkets(S.markets);

  let payout=0;
  S.portfolio.positions.forEach(p=>{
    if(p.mid!==u.id)return;
    const won=(p.side==='yes'&&p.outcomeIdx===winnerIdx)||(p.side==='no'&&p.outcomeIdx!==winnerIdx);
    if(won)payout+=p.shares;
  });
  if(payout>0){
    S.portfolio.balance=Math.round((S.portfolio.balance+payout)*100)/100;
    savePortfolio();
  }

  const payoutsByUser={};
  S.trades.forEach(t=>{
    if(t.mid!==u.id)return;
    const won=(t.side==='yes'&&t.outcomeIdx===winnerIdx)||(t.side==='no'&&t.outcomeIdx!==winnerIdx);
    if(!payoutsByUser[t.who])payoutsByUser[t.who]=0;
    if(won)payoutsByUser[t.who]+=t.shares;
  });
  if(useFirebase){
    Object.entries(payoutsByUser).forEach(([who,amt])=>{
      if(amt>0){
        db.ref('payouts/'+u.id+'_'+encodeKey(who)).set({
          mid:u.id,who,amount:Math.round(amt*100)/100,marketTitle:u.title,
          winner:u.outcomes[winnerIdx].label,ts:Date.now(),claimed:false
        });
      }
    });
  }

  logActivity({type:'resolve',user:S.name,marketId:u.id,winner:u.outcomes[winnerIdx].label,
    desc:`${S.name} resolved "${u.title}" â†’ ${u.outcomes[winnerIdx].label} wins`});

  S.resolving=null;S.sel=u;
  flash(`Resolved: "${u.outcomes[winnerIdx].label}" wins! Payouts distributed.`);
}

function cancelMarket(){
  const m=S.markets.find(x=>x.id===S.resolving.id);if(!m)return;
  const u=JSON.parse(JSON.stringify(m));
  u.resolved=true;u.cancelled=true;u.resolvedAt=new Date().toISOString();u.resolvedBy=S.name;
  S.markets=S.markets.map(x=>x.id===u.id?u:x);saveMarkets(S.markets);

  let refund=0;
  S.portfolio.positions.forEach(p=>{if(p.mid===u.id)refund+=p.amount||0});
  if(refund>0){S.portfolio.balance=Math.round((S.portfolio.balance+refund)*100)/100;savePortfolio()}

  if(useFirebase){
    const refundsByUser={};
    S.trades.forEach(t=>{if(t.mid!==u.id)return;if(!refundsByUser[t.who])refundsByUser[t.who]=0;refundsByUser[t.who]+=(t.amount||0)});
    Object.entries(refundsByUser).forEach(([who,amt])=>{
      if(amt>0)db.ref('payouts/'+u.id+'_'+encodeKey(who)).set({mid:u.id,who,amount:Math.round(amt*100)/100,marketTitle:u.title,winner:'CANCELLED',ts:Date.now(),claimed:false});
    });
  }
  logActivity({type:'cancel',user:S.name,marketId:u.id,desc:`${S.name} cancelled "${u.title}" â€” all refunded`});
  S.resolving=null;S.sel=u;flash("Market cancelled. Refunds distributed.");
}

function deleteMarket(id){
  const m=S.markets.find(x=>x.id===id);
  S.markets=S.markets.filter(x=>x.id!==id);saveMarkets(S.markets);
  if(useFirebase)db.ref('markets/'+id).remove();
  logActivity({type:'delete_market',user:S.name,marketId:id,desc:`${S.name} deleted market "${m?.title||id}"`});
  S.sel=null;S.resolving=null;S.editing=null;flash("Market deleted.");
}

// â”€â”€ Check for unclaimed payouts on load â”€â”€
function checkPayouts(){
  if(!useFirebase)return;
  db.ref('payouts').once('value',snap=>{
    const all=snap.val();if(!all)return;
    let totalPayout=0;
    Object.entries(all).forEach(([key,p])=>{
      if(p.who===S.name&&!p.claimed){
        totalPayout+=p.amount;
        db.ref('payouts/'+key+'/claimed').set(true);
      }
    });
    if(totalPayout>0){
      S.portfolio.balance=Math.round((S.portfolio.balance+totalPayout)*100)/100;
      savePortfolio();
      flash(`You received $${totalPayout.toFixed(0)} in payouts!`);
    }
  });
}

// â”€â”€ Admin: add funds to a user â”€â”€
function adminAddFunds(){
  const amt=parseFloat(S.addFundsAmt);
  const who=S.addFundsUser;
  if(!amt||!who){flash("Enter amount","err");return}
  const key=encodeKey(who);
  if(useFirebase){
    db.ref('users/'+key).once('value',snap=>{
      const u=snap.val()||{name:who,balance:10000};
      u.balance=Math.round((u.balance+amt)*100)/100;
      db.ref('users/'+key).set(u);
      db.ref('payouts/admin_'+Date.now()+'_'+key).set({
        mid:0,who,amount:amt,marketTitle:'Admin top-up by '+S.name,winner:'TOP-UP',ts:Date.now(),claimed:false
      });
      logActivity({type:'admin_funds',user:S.name,target:who,amount:amt,desc:`${S.name} added $${amt} to ${who}'s balance`});
      flash(`Added $${amt} to ${who}'s balance`);
      S.addFundsUser=null;S.addFundsAmt='';render();
    });
  }else{
    const u=S.users[key]||S.users[who]||{name:who,balance:10000};
    u.balance=Math.round((u.balance+amt)*100)/100;
    S.users[key]=u;localStorage.setItem('cmdp_users',JSON.stringify(S.users));
    if(who===S.name){S.portfolio.balance=u.balance;savePortfolio()}
    logActivity({type:'admin_funds',user:S.name,target:who,amount:amt,desc:`${S.name} added $${amt} to ${who}'s balance`});
    flash(`Added $${amt} to ${who}'s balance`);
    S.addFundsUser=null;S.addFundsAmt='';render();
  }
}

// â”€â”€ Admin: set balance directly â”€â”€
function adminSetBalance(who,newBalance){
  const key=encodeKey(who);
  const bal=Math.round(parseFloat(newBalance)*100)/100;
  if(isNaN(bal)){flash("Invalid balance","err");return}
  if(useFirebase){
    db.ref('users/'+key).once('value',snap=>{
      const u=snap.val()||{name:who,balance:10000};
      const oldBal=u.balance;
      u.balance=bal;
      db.ref('users/'+key).set(u);
      if(who===S.name){S.portfolio.balance=bal;savePortfolio()}
      logActivity({type:'admin_set_balance',user:S.name,target:who,oldBalance:oldBal,newBalance:bal,
        desc:`${S.name} set ${who}'s balance from $${oldBal} to $${bal}`});
      flash(`Set ${who}'s balance to $${bal}`);
      S.editingBalance=null;render();
    });
  }else{
    const u=S.users[key]||S.users[who]||{name:who,balance:10000};
    const oldBal=u.balance;
    u.balance=bal;
    S.users[key]=u;localStorage.setItem('cmdp_users',JSON.stringify(S.users));
    if(who===S.name){S.portfolio.balance=bal;savePortfolio()}
    logActivity({type:'admin_set_balance',user:S.name,target:who,oldBalance:oldBal,newBalance:bal,
      desc:`${S.name} set ${who}'s balance from $${oldBal} to $${bal}`});
    flash(`Set ${who}'s balance to $${bal}`);
    S.editingBalance=null;render();
  }
}

// â”€â”€ Admin: delete a user â”€â”€
function adminDeleteUser(who){
  if(!confirm(`Delete user "${who}"? This removes their profile but not their trade history.`))return;
  const key=encodeKey(who);
  if(useFirebase){
    db.ref('users/'+key).remove();
  }else{
    delete S.users[key];
    delete S.users[who];
    localStorage.setItem('cmdp_users',JSON.stringify(S.users));
  }
  logActivity({type:'admin_delete_user',user:S.name,target:who,desc:`${S.name} deleted user "${who}"`});
  flash(`Deleted user "${who}"`);
  render();
}

// â”€â”€ Admin: add a new user â”€â”€
function adminAddUser(){
  const name=S.newUserName.trim();
  const bal=parseFloat(S.newUserBalance)||10000;
  if(!name){flash("Enter a name","err");return}
  const key=encodeKey(name);
  const existing=S.users[key];
  if(existing){flash("User already exists","err");return}
  const u={name,balance:bal,lastSeen:Date.now()};
  if(useFirebase){
    db.ref('users/'+key).set(u);
  }else{
    S.users[key]=u;localStorage.setItem('cmdp_users',JSON.stringify(S.users));
  }
  logActivity({type:'admin_add_user',user:S.name,target:name,balance:bal,desc:`${S.name} added user "${name}" with $${bal}`});
  flash(`Added user "${name}" with $${bal}`);
  S.addingUser=false;S.newUserName='';S.newUserBalance='10000';render();
}

// â”€â”€ SPARKLINE â”€â”€
function spark(data,w,h,color){
  if(!data||data.length<2)return'';
  const mn=Math.min(...data)-.04,mx=Math.max(...data)+.04,rn=mx-mn||1,sx=w/(data.length-1);
  const pts=data.map((v,i)=>`${i*sx},${h-((v-mn)/rn)*h}`).join(' ');
  return`<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="overflow:visible;flex-shrink:0"><polyline fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" points="${pts}"/><circle cx="${(data.length-1)*sx}" cy="${h-((data[data.length-1]-mn)/rn)*h}" r="2" fill="${color}"/></svg>`;
}

// â”€â”€ LEADERBOARD â”€â”€
function getLeaderboard(){
  const map={};
  S.trades.forEach(t=>{
    if(!map[t.who])map[t.who]={name:t.who,trades:0,volume:0,pnl:0};
    map[t.who].trades++;map[t.who].volume+=(t.amount||0);
    const mk=S.markets.find(m=>m.id===t.mid);
    if(mk&&mk.outcomes[t.outcomeIdx]){
      if(mk.resolved){
        const won=(t.side==='yes'&&t.outcomeIdx===mk.winnerIdx)||(t.side==='no'&&t.outcomeIdx!==mk.winnerIdx);
        if(mk.cancelled){/* no pnl */}
        else if(won)map[t.who].pnl+=(t.shares-t.amount);
        else map[t.who].pnl+=(-t.amount);
      }else{
        const cur=t.side==='yes'?mk.outcomes[t.outcomeIdx].price:(1-mk.outcomes[t.outcomeIdx].price);
        map[t.who].pnl+=(cur-t.avg)*t.shares;
      }
    }
  });
  return Object.values(map).sort((a,b)=>b.pnl-a.pnl);
}

// â”€â”€ Helper: time ago â”€â”€
function timeAgo(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<60)return'just now';
  if(s<3600)return Math.floor(s/60)+'m ago';
  if(s<86400)return Math.floor(s/3600)+'h ago';
  return Math.floor(s/86400)+'d ago';
}

// â•â•â• RENDER â•â•â•
function render(){
  const app=document.getElementById('app'),s=S;
  if(s.ready&&!s.name){
    app.innerHTML=`<div class="setup-screen"><div class="setup-box">
      <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:4px">
        <div style="width:30px;height:30px;border-radius:5px;background:${T};display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:11px;color:#fff">CM</div>
        <span style="font-weight:700;font-size:17px">CMD<span style="color:${T}">predict</span></span>
      </div>
      <div style="font-size:12.5px;color:var(--tx3);margin-bottom:28px">Internal Prediction Market</div>
      ${useFirebase?`<div style="font-size:12px;color:var(--gn);margin-bottom:16px"><span class="live-dot"></span>Connected â€” real-time sync active</div>`:`<div style="background:#FEF3C7;border:1px solid #FDE68A;border-radius:8px;padding:12px;margin-bottom:20px;font-size:12px;color:#92400E;line-height:1.5;text-align:left">âš ï¸ <strong>Local mode.</strong></div>`}
      <div style="width:56px;height:56px;border-radius:50%;background:var(--tl);display:flex;align-items:center;justify-content:center;margin:0 auto 18px;font-size:24px">ğŸ‘¤</div>
      <h2 style="font-size:17px;font-weight:700;margin-bottom:5px">Welcome</h2>
      <p style="font-size:13px;color:var(--tx2);margin-bottom:22px;line-height:1.5">Enter your name to join.</p>
      <input id="name-input" placeholder="Your name (e.g. Quincy M.)" value="${s.nameIn}" style="margin-bottom:12px;text-align:center;font-size:14.5px">
      <button class="btn btn-t" id="name-btn" style="width:100%;padding:11px;font-size:14px">Enter CMDpredict</button>
    </div></div>`;
    const ni=document.getElementById('name-input');
    ni.addEventListener('input',e=>{S.nameIn=e.target.value});
    ni.addEventListener('keydown',e=>{if(e.key==='Enter')confirmName()});
    document.getElementById('name-btn').addEventListener('click',confirmName);
    ni.focus();return;
  }
  if(!s.ready){app.innerHTML=`<div class="setup-screen"><div class="m" style="color:${T}">Loading...</div></div>`;return}

  const list=s.markets.filter(m=>s.cat==='All'||m.category===s.cat).filter(m=>m.title.toLowerCase().includes(s.q.toLowerCase()))
    .sort((a,b)=>s.sort==='newest'?b.id-a.id:(b.volume||0)-(a.volume||0));
  const tv=s.markets.reduce((x,m)=>x+(m.volume||0),0),tt=s.trades.length,lb=getLeaderboard(),admin=isAdmin();
  const tabs=['markets','portfolio','leaderboard','activity'];
  if(admin)tabs.push('admin');

  app.innerHTML=`
  ${s.notif?`<div class="notif" style="color:${s.notif.type==='err'?RD:GN};border-color:${s.notif.type==='err'?RD:GN}">${s.notif.msg}</div>`:''}
  <header><div class="hdr-inner">
    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:6px;cursor:pointer" id="logo-click">
        <div style="width:24px;height:24px;border-radius:4px;background:${T};display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:9.5px;color:#fff">CM</div>
        <span style="font-weight:700;font-size:14.5px">CMD<span style="color:${T}">predict</span></span>
      </div>
      <div style="width:1px;height:20px;background:var(--bdr)"></div>
      <div style="display:flex;gap:1px">
        ${tabs.map(v=>`<button class="tab ${s.view===v?'active':''}" data-view="${v}">${v==='admin'?'âš™ï¸ Admin':v==='activity'?'ğŸ“‹ Activity':v[0].toUpperCase()+v.slice(1)}</button>`).join('')}
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px">
      ${useFirebase?'<span class="live-dot"></span>':''}
      <span class="m" style="font-size:12.5px;color:${GN};font-weight:600">$${s.portfolio.balance.toLocaleString()}</span>
      <button class="btn btn-t" id="new-market-btn" style="padding:5px 12px;font-size:12px">+ New Market</button>
      <div style="display:flex;align-items:center;gap:5px;padding:3px 8px 3px 3px;border-radius:18px;background:var(--tl)">
        <div style="width:24px;height:24px;border-radius:50%;background:${T};display:flex;align-items:center;justify-content:center;font-size:9.5px;font-weight:700;color:#fff">${s.name.slice(0,2).toUpperCase()}</div>
        <span style="font-size:12px;font-weight:600;color:${TD}">${s.name}</span>
        ${admin?'<span style="font-size:8px;background:#FEF3C7;color:#92400E;padding:1px 5px;border-radius:3px;font-weight:700">ADMIN</span>':''}
      </div>
    </div>
  </div></header>
  <main>

  ${s.view==='markets'?renderMarkets(list,tv,tt,lb):''}
  ${s.view==='portfolio'?renderPortfolio():''}
  ${s.view==='leaderboard'?renderLeaderboard(lb):''}
  ${s.view==='activity'?renderActivityFeed():''}
  ${s.view==='admin'&&admin?renderAdmin():''}

  </main>
  <footer>
    <div style="width:16px;height:16px;border-radius:3px;background:${T};display:flex;align-items:center;justify-content:center;font-family:'IBM Plex Mono',monospace;font-weight:700;font-size:6.5px;color:#fff">CM</div>
    <span>CMD<span style="color:${T}">predict</span></span><span>Â·</span><span>Serving Transparency in Capital Markets</span>
    ${useFirebase?'<span>Â·</span><span><span class="live-dot"></span>Real-time sync</span>':''}
  </footer>`;

  if(s.sel)mountDetail();
  if(s.creating)mountCreate();
  if(s.editing)mountEdit();
  if(s.resolving)mountResolve();
  if(s.viewingUser)mountUserProfile();
  if(s.addingUser&&admin)mountAddUser();
  bindEvents();
}

// â”€â”€ VIEW RENDERERS â”€â”€
function renderMarkets(list,tv,tt,lb){
  const s=S;
  return`
    <div class="stats-grid">
      ${[{l:'Active Markets',v:s.markets.filter(m=>!m.resolved).length,c:T},{l:'Total Volume',v:tv?'$'+(tv/1000).toFixed(1)+'K':'$0',c:GN},{l:'Total Trades',v:tt,c:'#F59E0B'},{l:'Analysts',v:lb.length,c:'#6366F1'}].map((x,i)=>`
        <div class="stat-card" style="animation:fu .3s ease ${i*.05}s both"><div class="stat-label">${x.l}</div><div class="m" style="font-size:20px;font-weight:700;color:${x.c}">${x.v}</div></div>`).join('')}
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <input id="search-input" placeholder="Search markets..." value="${s.q}" style="flex:1">
      <select id="sort-select" style="width:auto;min-width:115px"><option value="newest" ${s.sort==='newest'?'selected':''}>Newest</option><option value="volume" ${s.sort==='volume'?'selected':''}>Volume</option></select>
    </div>
    <div style="display:flex;gap:4px;margin-bottom:18px;flex-wrap:wrap">
      ${CATS.map(c=>`<button class="cat-btn" data-cat="${c}" style="padding:3px 9px;border-radius:4px;font-size:11px;font-weight:500;cursor:pointer;font-family:'Source Sans 3',sans-serif;border:1px solid ${s.cat===c?T:'var(--bdr)'};background:${s.cat===c?TL:'transparent'};color:${s.cat===c?T:'var(--tx2)'}">${c!=='All'?CI[c]+' ':''}${c}</button>`).join('')}
    </div>
    ${list.length===0?`<div style="text-align:center;padding:50px 20px;background:#fff;border:1px solid var(--bdr);border-radius:10px"><div style="font-size:40px;margin-bottom:12px">ğŸ›ï¸</div><div style="font-size:16px;font-weight:600;margin-bottom:6px">${s.markets.length===0?'No markets yet':'No matches'}</div><div style="font-size:13px;color:var(--tx2);max-width:360px;margin:0 auto 20px">${s.markets.length===0?'Create the first prediction market.':'Try a different filter.'}</div>${s.markets.length===0?'<button class="btn btn-t" id="first-market-btn">Create First Market</button>':''}</div>`
    :`<div class="market-grid">${list.map((m,i)=>`
      <div class="card" data-market-id="${m.id}" style="animation-delay:${i*.035}s;${m.resolved?'opacity:.65':''}">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px"><div style="display:flex;gap:5px;flex-wrap:wrap">
          <span class="pill" style="background:${TL};color:${T}">${CI[m.category]||'ğŸ”®'} ${m.category}</span>
          <span class="pill" style="background:#F0F4FF;color:#6366F1">${m.outcomes.length} outcomes</span>
          ${m.resolved?`<span class="${m.cancelled?'cancelled-badge':'resolved-badge'}">${m.cancelled?'CANCELLED':'RESOLVED'}</span>`:''}</div></div>
        <div style="font-size:14px;font-weight:600;line-height:1.4;margin-bottom:12px;min-height:36px">${m.title}</div>
        <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:10px">
          ${m.outcomes.slice(0,3).map((o,j)=>{const pct=Math.round(o.price*100),w=m.resolved&&m.winnerIdx===j;
            return`<div style="display:flex;align-items:center;gap:8px"><div style="font-size:12px;color:${w?GN:'#334155'};font-weight:${w?700:500};min-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${w?'âœ“ ':''}${o.label}</div><div style="flex:1;height:6px;border-radius:3px;background:#EEF2F7;overflow:hidden"><div style="height:100%;border-radius:3px;background:${w?GN:T};width:${pct}%"></div></div><span class="m" style="font-size:12px;font-weight:700;color:${w?GN:T};min-width:32px;text-align:right">${pct}Â¢</span></div>`}).join('')}
          ${m.outcomes.length>3?`<div style="font-size:11px;color:var(--tx3)">+${m.outcomes.length-3} more</div>`:''}
        </div>
        <div style="font-size:10.5px;color:#B0B8C4;display:flex;gap:8px;flex-wrap:wrap"><span>by ${m.creator}</span>${m.volume?`<span>Â· $${(m.volume/1000).toFixed(1)}K vol</span>`:''}<span>Â· ${m.traders||0} trades</span><span>Â· ends ${new Date(m.endDate).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}</span></div>
      </div>`).join('')}</div>`}`;
}

function renderPortfolio(){
  const s=S;
  return`<h2 style="font-size:18px;font-weight:700;margin-bottom:18px">Your Portfolio</h2>
    <div class="port-grid">${[{l:'Cash Balance',v:'$'+s.portfolio.balance.toLocaleString(),c:GN},{l:'Open Positions',v:s.portfolio.positions.length,c:T},{l:'Markets Traded',v:[...new Set(s.portfolio.positions.map(p=>p.mid))].length,c:'#F59E0B'}].map(x=>`<div class="stat-card"><div class="stat-label">${x.l}</div><div class="m" style="font-size:21px;font-weight:700;color:${x.c}">${x.v}</div></div>`).join('')}</div>
    ${s.portfolio.positions.length===0?`<div style="text-align:center;padding:40px;color:var(--tx3);background:#fff;border:1px solid var(--bdr);border-radius:10px"><div style="font-size:32px;margin-bottom:8px">ğŸ“ˆ</div><div style="font-size:14px">No positions yet</div></div>`:`
      <div style="display:flex;flex-direction:column;gap:8px">${s.portfolio.positions.map(p=>{
        const mk=s.markets.find(m=>m.id===p.mid);let cur=p.avg;
        if(mk&&mk.outcomes[p.outcomeIdx]){const op=mk.outcomes[p.outcomeIdx].price;cur=p.side==='yes'?op:(1-op)}
        const pnl=(cur-p.avg)*p.shares;
        return`<div style="background:#fff;border:1px solid var(--bdr);border-radius:8px;padding:13px 15px;display:flex;justify-content:space-between;align-items:center">
          <div style="min-width:0;flex:1"><div style="font-size:13px;font-weight:600;margin-bottom:3px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${p.title}</div>
            <div style="display:flex;gap:8px;font-size:11px;color:var(--tx3);align-items:center;flex-wrap:wrap"><span class="pill" style="background:${p.side==='yes'?'rgba(16,185,129,.07)':'rgba(239,68,68,.07)'};color:${p.side==='yes'?GN:RD}">${p.side.toUpperCase()}</span><span style="color:${T};font-weight:600">${p.outcomeLabel}</span><span>${p.shares} @ ${Math.round(p.avg*100)}Â¢</span></div>
          </div>
          <div style="text-align:right;flex-shrink:0"><div class="m" style="font-size:13.5px;font-weight:700;color:${pnl>=0?GN:RD}">${pnl>=0?'+':''}${pnl.toFixed(0)}</div><div style="font-size:10px;color:var(--tx3)">now ${Math.round(cur*100)}Â¢</div></div>
        </div>`}).join('')}</div>`}`;
}

function renderLeaderboard(lb){
  return`<h2 style="font-size:18px;font-weight:700;margin-bottom:6px">Analyst Leaderboard</h2>
    <p style="font-size:12.5px;color:var(--tx2);margin-bottom:18px">Click any analyst to view their full trade history and P&L breakdown.</p>
    ${lb.length===0?`<div style="text-align:center;padding:40px;color:var(--tx3);background:#fff;border:1px solid var(--bdr);border-radius:10px"><div style="font-size:32px;margin-bottom:8px">ğŸ†</div><div style="font-size:14px">No trades yet</div></div>`:`
      <div style="background:#fff;border:1px solid var(--bdr);border-radius:10px;overflow:hidden">
        <div style="display:grid;grid-template-columns:40px 1fr 90px 80px 70px;padding:10px 14px;border-bottom:1px solid var(--bdr);font-size:9.5px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;font-weight:600"><span>#</span><span>Analyst</span><span style="text-align:right">P&amp;L</span><span style="text-align:right">Volume</span><span style="text-align:right">Trades</span></div>
        ${lb.map((u,i)=>`<div class="view-user-btn" data-user="${u.name}" style="display:grid;grid-template-columns:40px 1fr 90px 80px 70px;padding:12px 14px;border-bottom:1px solid #F1F5F9;align-items:center;cursor:pointer;transition:background .1s;${u.name===S.name?'background:'+TL:''}" onmouseover="this.style.background='${TL}'" onmouseout="this.style.background='${u.name===S.name?TL:''}'">
          <span class="m" style="font-weight:700;font-size:13px;color:${i===0?'#F59E0B':i===1?'#94A3B8':i===2?'#CD7F32':'#CBD5E1'}">${i+1}</span>
          <div style="display:flex;align-items:center;gap:8px"><div style="width:26px;height:26px;border-radius:50%;background:${T};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff">${u.name.slice(0,2).toUpperCase()}</div><span style="font-weight:600;font-size:13px">${u.name}${u.name===S.name?' (you)':''}</span></div>
          <span class="m" style="text-align:right;font-weight:700;font-size:13px;color:${u.pnl>=0?GN:RD}">${u.pnl>=0?'+':''}$${Math.abs(u.pnl).toFixed(0)}</span>
          <span class="m" style="text-align:right;color:var(--tx2);font-size:12px">$${u.volume.toFixed(0)}</span>
          <span class="m" style="text-align:right;color:var(--tx2);font-size:12px">${u.trades}</span>
        </div>`).join('')}
      </div>`}`;
}

// â”€â”€ ACTIVITY FEED (visible to all) â”€â”€
function renderActivityFeed(){
  const recentTrades=[...S.trades].sort((a,b)=>b.ts-a.ts).slice(0,50);
  const recentActivity=activityLog.slice(0,30);

  // Merge trades + activity into one timeline
  const timeline=[];
  recentTrades.forEach(t=>{
    timeline.push({ts:t.ts,type:'trade',data:t});
  });
  recentActivity.forEach(a=>{
    if(a.type!=='trade')timeline.push({ts:a.ts,type:a.type,data:a});
  });
  timeline.sort((a,b)=>b.ts-a.ts);
  const items=timeline.slice(0,60);

  const icons={trade:'ğŸ’°',market_created:'ğŸ›ï¸',resolve:'ğŸ',cancel:'âŒ',join:'ğŸ‘‹',admin_funds:'ğŸ’¸',admin_set_balance:'âš–ï¸',admin_add_user:'â•',admin_delete_user:'ğŸ—‘ï¸',delete_market:'ğŸ—‘ï¸'};

  return`<h2 style="font-size:18px;font-weight:700;margin-bottom:6px">Activity Feed</h2>
    <p style="font-size:12.5px;color:var(--tx2);margin-bottom:18px">All trading activity and market events. Click any user to view their profile.</p>
    ${items.length===0?`<div style="text-align:center;padding:40px;color:var(--tx3);background:#fff;border:1px solid var(--bdr);border-radius:10px"><div style="font-size:32px;margin-bottom:8px">ğŸ“‹</div><div style="font-size:14px">No activity yet â€” start trading!</div></div>`:`
      <div style="background:#fff;border:1px solid var(--bdr);border-radius:10px;overflow:hidden">
        ${items.map(item=>{
          if(item.type==='trade'){
            const t=item.data;
            return`<div class="activity-row">
              <div style="display:flex;align-items:center;gap:10px;min-width:0;flex:1">
                <span style="font-size:16px;flex-shrink:0">ğŸ’°</span>
                <div style="min-width:0">
                  <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
                    <span class="view-user-btn" data-user="${t.who}" style="font-weight:600;color:${T};cursor:pointer">${t.who}</span>
                    <span>bought</span>
                    <span class="pill" style="background:${t.side==='yes'?'rgba(16,185,129,.07)':'rgba(239,68,68,.07)'};color:${t.side==='yes'?GN:RD}">${t.side.toUpperCase()}</span>
                    <span style="font-weight:500">"${t.outcomeLabel}"</span>
                  </div>
                  <div style="font-size:11px;color:var(--tx3);margin-top:2px">${t.title} Â· ${t.shares} shares @ ${Math.round(t.avg*100)}Â¢ Â· $${(t.amount||0).toFixed(0)}</div>
                </div>
              </div>
              <span style="font-size:11px;color:var(--tx3);flex-shrink:0;margin-left:8px">${timeAgo(item.ts)}</span>
            </div>`;
          }else{
            const a=item.data;
            return`<div class="activity-row">
              <div style="display:flex;align-items:center;gap:10px;min-width:0;flex:1">
                <span style="font-size:16px;flex-shrink:0">${icons[a.type]||'ğŸ“Œ'}</span>
                <div style="min-width:0">
                  <div style="font-size:12.5px">${a.desc||a.type}</div>
                </div>
              </div>
              <span style="font-size:11px;color:var(--tx3);flex-shrink:0;margin-left:8px">${timeAgo(item.ts)}</span>
            </div>`;
          }
        }).join('')}
      </div>`}`;
}

// â”€â”€ ADMIN PANEL â”€â”€
function renderAdmin(){
  const users=Object.values(S.users).sort((a,b)=>(b.balance||0)-(a.balance||0));
  return`<h2 style="font-size:18px;font-weight:700;margin-bottom:18px">âš™ï¸ Admin Panel</h2>
    <div class="stats-grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card"><div class="stat-label">Registered Users</div><div class="m" style="font-size:20px;font-weight:700;color:${T}">${users.length}</div></div>
      <div class="stat-card"><div class="stat-label">Total Markets</div><div class="m" style="font-size:20px;font-weight:700;color:${GN}">${S.markets.length}</div></div>
      <div class="stat-card"><div class="stat-label">Total Trades</div><div class="m" style="font-size:20px;font-weight:700;color:#F59E0B">${S.trades.length}</div></div>
      <div class="stat-card"><div class="stat-label">Activity Log</div><div class="m" style="font-size:20px;font-weight:700;color:#6366F1">${activityLog.length}</div></div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="font-size:15px;font-weight:700">All Users</h3>
      <button class="btn btn-t" id="admin-add-user-btn" style="padding:5px 12px;font-size:12px">+ Add User</button>
    </div>

    ${users.length===0?`<div style="padding:30px;text-align:center;color:var(--tx3);background:#fff;border:1px solid var(--bdr);border-radius:10px">No users registered yet. Users appear here once they log in or you add them manually.</div>`:`
      <div style="background:#fff;border:1px solid var(--bdr);border-radius:10px;overflow:hidden">
        <div class="user-row-admin" style="padding:10px 14px;border-bottom:1px solid var(--bdr);font-size:9.5px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;display:grid;cursor:default">
          <span>User</span><span style="text-align:right">Balance</span><span style="text-align:right">Last Active</span><span style="text-align:right">Actions</span>
        </div>
        ${users.map(u=>{
          const stats=getUserStats(u.name);
          return`
          <div class="user-row-admin" style="display:grid;cursor:default">
            <div style="display:flex;align-items:center;gap:8px;cursor:pointer" class="view-user-btn" data-user="${u.name}">
              <div style="width:26px;height:26px;border-radius:50%;background:${T};display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff">${(u.name||'?').slice(0,2).toUpperCase()}</div>
              <div>
                <span style="font-weight:600;font-size:13px;color:${T}">${u.name||'Unknown'}</span>
                <div style="font-size:10px;color:var(--tx3)">${stats.totalTrades} trades Â· P&L: <span style="color:${stats.totalPnl>=0?GN:RD}">${stats.totalPnl>=0?'+':''}$${Math.abs(stats.totalPnl).toFixed(0)}</span></div>
              </div>
            </div>
            <div style="text-align:right;display:flex;align-items:center;justify-content:flex-end">
              ${S.editingBalance===u.name
                ?`<input type="number" class="editable-balance admin-balance-input" data-user="${u.name}" value="${u.balance||0}" style="border-color:${T};background:#fff;box-shadow:0 0 0 3px rgba(27,138,158,.08)">`
                :`<span class="editable-balance admin-balance-edit" data-user="${u.name}" title="Click to edit" style="color:${(u.balance||0)>=0?GN:RD}">$${(u.balance||0).toLocaleString()}</span>`}
            </div>
            <span style="text-align:right;font-size:11px;color:var(--tx3)">${u.lastSeen?timeAgo(u.lastSeen):'-'}</span>
            <div style="text-align:right;display:flex;gap:4px;justify-content:flex-end">
              <button class="btn btn-ghost add-funds-btn" data-user="${u.name}" style="padding:4px 8px;font-size:11px">+ Funds</button>
              <button class="btn btn-danger admin-delete-btn" data-user="${u.name}" style="padding:4px 8px;font-size:11px">Delete</button>
            </div>
          </div>`;
        }).join('')}
      </div>
    `}

    ${S.addFundsUser?`
      <div style="margin-top:16px;background:#fff;border:1px solid var(--bdr);border-radius:10px;padding:18px">
        <h4 style="font-size:14px;font-weight:600;margin-bottom:10px">Add funds to: <span style="color:${T}">${S.addFundsUser}</span></h4>
        <div style="display:flex;gap:8px">
          <input type="number" id="add-funds-amount" placeholder="Amount ($)" value="${S.addFundsAmt}" style="flex:1">
          <button class="btn btn-t" id="add-funds-btn">Add Funds</button>
          <button class="btn btn-ghost" id="cancel-funds-btn">Cancel</button>
        </div>
      </div>
    `:''}

    <h3 style="font-size:15px;font-weight:700;margin-top:24px;margin-bottom:12px">Recent Activity Log</h3>
    <div style="background:#fff;border:1px solid var(--bdr);border-radius:10px;overflow:hidden;max-height:400px;overflow-y:auto">
      ${activityLog.length===0?`<div style="padding:20px;text-align:center;color:var(--tx3);font-size:13px">No activity logged yet. Actions will appear here as users trade, create markets, etc.</div>`:`
        ${activityLog.slice(0,40).map(a=>`<div class="activity-row">
          <div style="display:flex;align-items:center;gap:8px;min-width:0;flex:1">
            <span style="font-size:14px">${{trade:'ğŸ’°',market_created:'ğŸ›ï¸',resolve:'ğŸ',cancel:'âŒ',join:'ğŸ‘‹',admin_funds:'ğŸ’¸',admin_set_balance:'âš–ï¸',admin_add_user:'â•',admin_delete_user:'ğŸ—‘ï¸',delete_market:'ğŸ—‘ï¸'}[a.type]||'ğŸ“Œ'}</span>
            <span style="font-size:12px;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${a.desc||a.type}</span>
          </div>
          <span style="font-size:10.5px;color:var(--tx3);flex-shrink:0">${timeAgo(a.ts)}</span>
        </div>`).join('')}
      `}
    </div>`;
}

// â”€â”€ USER PROFILE MODAL (visible to everyone) â”€â”€
function mountUserProfile(){
  const userName=S.viewingUser;
  const stats=getUserStats(userName);
  const userInfo=Object.values(S.users).find(u=>u.name===userName);
  const balance=userInfo?userInfo.balance:null;

  let html=`<div class="overlay" id="userprofile-overlay"><div class="modal modal-lg">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:42px;height:42px;border-radius:50%;background:${T};display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff">${userName.slice(0,2).toUpperCase()}</div>
        <div>
          <h2 style="font-size:17px;font-weight:700">${userName}${userName===S.name?' (you)':''}</h2>
          ${balance!==null?`<div class="m" style="font-size:13px;color:${GN};font-weight:600">Balance: $${balance.toLocaleString()}</div>`:''}
        </div>
      </div>
      <button class="xbtn" id="close-userprofile">Ã—</button>
    </div>

    <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:18px">
      <div class="stat-card"><div class="stat-label">Total P&L</div><div class="m" style="font-size:18px;font-weight:700;color:${stats.totalPnl>=0?GN:RD}">${stats.totalPnl>=0?'+':''}$${Math.abs(stats.totalPnl).toFixed(0)}</div></div>
      <div class="stat-card"><div class="stat-label">Total Volume</div><div class="m" style="font-size:18px;font-weight:700;color:${T}">$${stats.totalVolume.toFixed(0)}</div></div>
      <div class="stat-card"><div class="stat-label">Win / Loss</div><div class="m" style="font-size:18px;font-weight:700"><span style="color:${GN}">${stats.wins}</span> <span style="color:var(--tx3)">/</span> <span style="color:${RD}">${stats.losses}</span></div></div>
      <div class="stat-card"><div class="stat-label">Total Trades</div><div class="m" style="font-size:18px;font-weight:700;color:#6366F1">${stats.totalTrades}</div></div>
    </div>

    <h3 style="font-size:14px;font-weight:700;margin-bottom:10px">Trade History</h3>
    ${stats.trades.length===0?`<div style="padding:24px;text-align:center;color:var(--tx3);background:#F8FAFC;border-radius:8px;font-size:13px">No trades yet</div>`:`
      <div style="background:#fff;border:1px solid var(--bdr);border-radius:8px;overflow:hidden;max-height:400px;overflow-y:auto">
        <div style="display:grid;grid-template-columns:1fr 70px 80px 70px 60px;padding:8px 12px;border-bottom:1px solid var(--bdr);font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;font-weight:600">
          <span>Market</span><span style="text-align:center">Side</span><span style="text-align:right">Amount</span><span style="text-align:right">P&L</span><span style="text-align:right">Status</span>
        </div>
        ${stats.trades.map(t=>{
          const statusColors={won:GN,lost:RD,open:T,cancelled:'#92400E'};
          const statusBg={won:'#DCFCE7',lost:'#FEE2E2',open:TL,cancelled:'#FEF3C7'};
          return`<div style="display:grid;grid-template-columns:1fr 70px 80px 70px 60px;padding:10px 12px;border-bottom:1px solid #F1F5F9;align-items:center;font-size:12px">
            <div style="min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
              <div style="font-weight:600;font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.marketTitle}</div>
              <div style="font-size:10.5px;color:var(--tx3)">${t.outcomeLabel} Â· ${t.shares} shares @ ${Math.round(t.avg*100)}Â¢</div>
            </div>
            <div style="text-align:center"><span class="pill" style="background:${t.side==='yes'?'rgba(16,185,129,.07)':'rgba(239,68,68,.07)'};color:${t.side==='yes'?GN:RD}">${t.side.toUpperCase()}</span></div>
            <span class="m" style="text-align:right;font-size:11.5px">$${(t.amount||0).toFixed(0)}</span>
            <span class="m" style="text-align:right;font-weight:700;color:${t.pnl>=0?GN:RD};font-size:11.5px">${t.pnl>=0?'+':''}$${Math.abs(t.pnl).toFixed(0)}</span>
            <div style="text-align:right"><span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:3px;background:${statusBg[t.status]||'#F1F5F9'};color:${statusColors[t.status]||'var(--tx3)'};text-transform:uppercase;letter-spacing:.3px">${t.status}</span></div>
          </div>`;
        }).join('')}
      </div>`}
  </div></div>`;

  document.getElementById('app').insertAdjacentHTML('beforeend',html);
  document.getElementById('close-userprofile').onclick=()=>{S.viewingUser=null;render()};
  document.getElementById('userprofile-overlay').onclick=e=>{if(e.target===e.currentTarget){S.viewingUser=null;render()}};
}

// â”€â”€ ADD USER MODAL (admin only) â”€â”€
function mountAddUser(){
  let html=`<div class="overlay" id="adduser-overlay"><div class="modal" style="max-width:420px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><h2 style="font-size:16.5px;font-weight:700">â• Add New User</h2><button class="xbtn" id="close-adduser">Ã—</button></div>
    <p style="font-size:12.5px;color:var(--tx2);margin-bottom:16px;line-height:1.5">Create a new user profile. They'll pick up this balance when they log in with this name.</p>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">Name *</label><input id="new-user-name" placeholder="e.g. Jane D." value="${S.newUserName}"></div>
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">Starting Balance</label><input type="number" id="new-user-balance" placeholder="10000" value="${S.newUserBalance}"></div>
      <button class="btn btn-t" id="confirm-add-user" style="width:100%;padding:11px;font-size:13.5px">Add User</button>
    </div>
  </div></div>`;
  document.getElementById('app').insertAdjacentHTML('beforeend',html);
  document.getElementById('close-adduser').onclick=()=>{S.addingUser=false;render()};
  document.getElementById('adduser-overlay').onclick=e=>{if(e.target===e.currentTarget){S.addingUser=false;render()}};
  document.getElementById('new-user-name').oninput=e=>{S.newUserName=e.target.value};
  document.getElementById('new-user-balance').oninput=e=>{S.newUserBalance=e.target.value};
  document.getElementById('confirm-add-user').onclick=adminAddUser;
}

// â”€â”€ MODAL MOUNTS â”€â”€
function mountDetail(){
  const s=S,m=s.sel,admin=isAdmin(),canEdit=admin||m.creator===s.name;

  // Get recent trades on this market
  const marketTrades=[...S.trades].filter(t=>t.mid===m.id).sort((a,b)=>b.ts-a.ts).slice(0,10);

  let html=`<div class="overlay" id="detail-overlay"><div class="modal modal-lg">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
      <div><div style="display:flex;gap:5px;margin-bottom:5px;flex-wrap:wrap">
        <span class="pill" style="background:${TL};color:${T}">${CI[m.category]||'ğŸ”®'} ${m.category}</span>
        <span class="pill" style="background:#F0F4FF;color:#6366F1">${m.outcomes.length} contracts</span>
        ${m.resolved?`<span class="${m.cancelled?'cancelled-badge':'resolved-badge'}">${m.cancelled?'CANCELLED':'RESOLVED'}</span>`:''}</div>
        <h2 style="font-size:16.5px;font-weight:700;line-height:1.4">${m.title}</h2></div>
      <button class="xbtn" id="close-detail">Ã—</button></div>
    <p style="font-size:13px;color:var(--tx2);line-height:1.5;margin-bottom:14px">${m.description}</p>
    ${canEdit&&!m.resolved?`<div style="display:flex;gap:6px;margin-bottom:14px"><button class="btn btn-ghost" id="edit-market-btn">âœï¸ Edit</button>${admin?`<button class="btn btn-ghost" id="resolve-market-btn" style="border-color:#F59E0B;color:#B45309">ğŸ Resolve</button>`:''}</div>`:''}
    ${m.resolved&&m.resolvedBy?`<div style="font-size:12px;color:${m.cancelled?'#92400E':'#166534'};margin-bottom:12px;padding:8px 12px;background:${m.cancelled?'#FEF3C7':'#F0FDF4'};border-radius:6px;border:1px solid ${m.cancelled?'#FDE68A':'#BBF7D0'}">${m.cancelled?'Cancelled':'Resolved: <strong>'+m.outcomes[m.winnerIdx]?.label+'</strong> won'} â€” by ${m.resolvedBy}</div>`:''}
    <div style="font-size:11px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Contracts</div>
    <div style="display:flex;flex-direction:column;gap:5px;margin-bottom:16px">
      ${m.outcomes.map((o,j)=>{const pct=Math.round(o.price*100),active=s.selOc===j,w=m.resolved&&m.winnerIdx===j;
        return`<div class="outcome-row" data-idx="${j}" style="display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;border:2px solid ${active&&!m.resolved?T:'transparent'};background:${w?'#F0FDF4':active?'var(--tll)':'#F8FAFC'}">
          <div style="flex:1;min-width:0"><div style="font-size:13.5px;font-weight:600;margin-bottom:4px;color:${w?GN:'var(--tx)'}">${w?'âœ“ ':''}${o.label}</div><div style="height:5px;border-radius:3px;background:#E2E8F0;overflow:hidden"><div style="height:100%;border-radius:3px;background:${w?GN:T};width:${pct}%"></div></div></div>
          <div style="text-align:right;flex-shrink:0"><div class="m" style="font-size:18px;font-weight:700;color:${w?GN:T}">${pct}Â¢</div></div>
          ${spark(o.history,56,18,w?GN:T)}</div>`}).join('')}
    </div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:16px">
      ${[{l:'Volume',v:m.volume?'$'+(m.volume/1000).toFixed(1)+'K':'$0'},{l:'Liquidity',v:'$'+(m.liquidity/1000).toFixed(1)+'K'},{l:'Trades',v:m.traders||0},{l:'Ends',v:new Date(m.endDate).toLocaleDateString('en-GB',{day:'numeric',month:'short'})}].map(x=>`<div style="text-align:center"><div style="font-size:9px;color:var(--tx3);text-transform:uppercase;letter-spacing:.4px;margin-bottom:2px">${x.l}</div><div class="m" style="font-size:12px;font-weight:600;color:#334155">${x.v}</div></div>`).join('')}
    </div>
    ${m.resolved?'':`<div style="background:#F8FAFC;border-radius:8px;padding:16px;border:1px solid var(--bdr)">
      <div style="font-size:12px;font-weight:600;color:#334155;margin-bottom:10px">Trading: <span style="color:${T}">${m.outcomes[s.selOc]?.label||''}</span></div>
      <div style="display:flex;margin-bottom:10px;background:#EEF2F7;border-radius:5px;padding:2px">
        <button class="side-btn" data-side="yes" style="flex:1;padding:7px;border:none;border-radius:4px;cursor:pointer;font-family:'Source Sans 3',sans-serif;font-weight:600;font-size:12.5px;background:${s.side==='yes'?GN:'transparent'};color:${s.side==='yes'?'#fff':'var(--tx3)'}">Buy YES ${Math.round((m.outcomes[s.selOc]?.price||.5)*100)}Â¢</button>
        <button class="side-btn" data-side="no" style="flex:1;padding:7px;border:none;border-radius:4px;cursor:pointer;font-family:'Source Sans 3',sans-serif;font-weight:600;font-size:12.5px;background:${s.side==='no'?RD:'transparent'};color:${s.side==='no'?'#fff':'var(--tx3)'}">Buy NO ${Math.round((1-(m.outcomes[s.selOc]?.price||.5))*100)}Â¢</button>
      </div>
      <input type="number" id="trade-amount" placeholder="Amount ($)" value="${s.amt}" style="margin-bottom:6px">
      <div id="trade-preview" style="font-size:12px;color:var(--tx2);margin-bottom:6px"></div>
      <button class="btn" id="trade-btn" style="width:100%;padding:10px;font-size:13.5px;background:${s.side==='yes'?GN:RD};color:#fff">Buy ${s.side.toUpperCase()}</button>
      <div style="font-size:10px;color:var(--tx3);text-align:center;margin-top:6px">Balance: $${s.portfolio.balance.toLocaleString()}</div>
    </div>`}

    ${marketTrades.length>0?`
      <div style="margin-top:16px">
        <div style="font-size:11px;font-weight:600;color:var(--tx3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">Recent Activity</div>
        <div style="background:#F8FAFC;border-radius:8px;border:1px solid var(--bdr);overflow:hidden">
          ${marketTrades.map(t=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #EEF2F7;font-size:12px">
            <div style="display:flex;align-items:center;gap:6px">
              <span class="view-user-btn" data-user="${t.who}" style="font-weight:600;color:${T};cursor:pointer">${t.who}</span>
              <span class="pill" style="background:${t.side==='yes'?'rgba(16,185,129,.07)':'rgba(239,68,68,.07)'};color:${t.side==='yes'?GN:RD};font-size:9px">${t.side.toUpperCase()}</span>
              <span>${t.outcomeLabel}</span>
              <span style="color:var(--tx3)">$${(t.amount||0).toFixed(0)}</span>
            </div>
            <span style="color:var(--tx3);font-size:10.5px">${timeAgo(t.ts)}</span>
          </div>`).join('')}
        </div>
      </div>`:''}

    <div style="margin-top:10px;font-size:10.5px;color:var(--tx3);display:flex;justify-content:space-between"><span>by ${m.creator}</span><span>ends ${new Date(m.endDate).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}</span></div>
  </div></div>`;
  document.getElementById('app').insertAdjacentHTML('beforeend',html);

  const amtInput=document.getElementById('trade-amount');
  const preview=document.getElementById('trade-preview');
  const tradeBtn=document.getElementById('trade-btn');
  function updatePreview(){
    const a=parseFloat(amtInput?.value||'0');
    S.amt=amtInput?.value||'';
    if(a>0&&m.outcomes[s.selOc]){
      const pr=s.side==='yes'?m.outcomes[s.selOc].price:(1-m.outcomes[s.selOc].price);
      const sh=(a/pr).toFixed(1),po=(a/pr).toFixed(0);
      if(preview)preview.innerHTML=`<div style="display:flex;justify-content:space-between"><span>${sh} shares @ ${Math.round(pr*100)}Â¢</span><span style="color:${GN};font-weight:600">Payout: $${po}</span></div>`;
      if(tradeBtn)tradeBtn.textContent=`Buy ${s.side.toUpperCase()} Â· $${S.amt}`;
    }else{
      if(preview)preview.innerHTML='';
      if(tradeBtn)tradeBtn.textContent=`Buy ${s.side.toUpperCase()}`;
    }
  }
  if(amtInput){amtInput.addEventListener('input',updatePreview);updatePreview()}

  document.getElementById('close-detail').onclick=()=>{S.sel=null;render()};
  document.getElementById('detail-overlay').onclick=e=>{if(e.target===e.currentTarget){S.sel=null;render()}};
  document.querySelectorAll('.outcome-row').forEach(el=>{el.onclick=()=>{if(!S.sel.resolved){S.selOc=parseInt(el.dataset.idx);S.side='yes';render()}}});
  document.querySelectorAll('.side-btn').forEach(el=>{el.onclick=e=>{e.stopPropagation();S.side=el.dataset.side;render()}});
  if(tradeBtn)tradeBtn.onclick=trade;
  if(document.getElementById('edit-market-btn'))document.getElementById('edit-market-btn').onclick=()=>{
    S.editing=S.sel;S.editForm={title:S.sel.title,desc:S.sel.description,end:S.sel.endDate,outcomes:S.sel.outcomes.map(o=>o.label)};render()};
  if(document.getElementById('resolve-market-btn'))document.getElementById('resolve-market-btn').onclick=()=>{S.resolving=S.sel;render()};
}

function mountCreate(){
  const f=S.form;
  let html=`<div class="overlay" id="create-overlay"><div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><h2 style="font-size:16.5px;font-weight:700">Create a New Market</h2><button class="xbtn" id="close-create">Ã—</button></div>
    <p style="font-size:12.5px;color:var(--tx2);margin-bottom:16px;line-height:1.5">Each outcome can be traded YES or NO â€” prices normalise to 100%.</p>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">Question *</label><input id="f-title" placeholder="e.g. How many OKR meetings in Q3?" value="${f.title}"></div>
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">Resolution Criteria</label><textarea id="f-desc" rows="2" placeholder="How does this resolve?" style="resize:vertical">${f.desc}</textarea></div>
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:6px;display:block;font-weight:600">Outcomes *</label>
        <div style="display:flex;flex-direction:column;gap:5px">${f.outcomes.map((o,i)=>`<div style="display:flex;gap:6px;align-items:center"><span class="m" style="font-size:10.5px;color:var(--tx3);min-width:18px">${i+1}.</span><input class="outcome-input" data-idx="${i}" placeholder="Outcome ${i+1}" value="${o}" style="flex:1">${f.outcomes.length>2?`<button class="remove-outcome" data-idx="${i}" style="background:none;border:none;cursor:pointer;color:var(--tx3);font-size:15px;padding:0 3px">Ã—</button>`:''}</div>`).join('')}</div>
        <button id="add-outcome" style="background:none;border:1px dashed #D1D9E6;border-radius:5px;padding:6px;cursor:pointer;font-size:12px;color:var(--tx2);font-family:'Source Sans 3',sans-serif;width:100%;margin-top:5px">+ Add outcome</button></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">Category</label><select id="f-cat">${CATS.filter(c=>c!=='All').map(c=>`<option value="${c}" ${f.cat===c?'selected':''}>${CI[c]} ${c}</option>`).join('')}</select></div>
        <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">End Date *</label><input type="date" id="f-end" value="${f.end}"></div></div>
      <button class="btn btn-t" id="create-btn" style="width:100%;padding:11px;font-size:13.5px;margin-top:2px">Create Market</button>
    </div></div></div>`;
  document.getElementById('app').insertAdjacentHTML('beforeend',html);
  document.getElementById('close-create').onclick=()=>{S.creating=false;render()};
  document.getElementById('create-overlay').onclick=e=>{if(e.target===e.currentTarget){S.creating=false;render()}};
  document.getElementById('f-title').oninput=e=>{S.form.title=e.target.value};
  document.getElementById('f-desc').oninput=e=>{S.form.desc=e.target.value};
  document.getElementById('f-cat').onchange=e=>{S.form.cat=e.target.value};
  document.getElementById('f-end').onchange=e=>{S.form.end=e.target.value};
  document.querySelectorAll('.outcome-input').forEach(el=>{el.oninput=e=>{S.form.outcomes[parseInt(el.dataset.idx)]=e.target.value}});
  document.querySelectorAll('.remove-outcome').forEach(el=>{el.onclick=()=>{S.form.outcomes.splice(parseInt(el.dataset.idx),1);render()}});
  document.getElementById('add-outcome').onclick=()=>{S.form.outcomes.push('');render()};
  document.getElementById('create-btn').onclick=createMarket;
}

function mountEdit(){
  const ef=S.editForm;
  let html=`<div class="overlay" id="edit-overlay"><div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><h2 style="font-size:16.5px;font-weight:700">Edit Market</h2><button class="xbtn" id="close-edit">Ã—</button></div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">Question</label><input id="ef-title" value="${ef.title}"></div>
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">Description</label><textarea id="ef-desc" rows="2" style="resize:vertical">${ef.desc}</textarea></div>
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:6px;display:block;font-weight:600">Outcomes</label>
        <div style="display:flex;flex-direction:column;gap:5px">${ef.outcomes.map((o,i)=>`<div style="display:flex;gap:6px;align-items:center"><span class="m" style="font-size:10.5px;color:var(--tx3);min-width:18px">${i+1}.</span><input class="edit-outcome" data-idx="${i}" value="${o}" style="flex:1">${ef.outcomes.length>2?`<button class="rm-edit-oc" data-idx="${i}" style="background:none;border:none;cursor:pointer;color:var(--tx3);font-size:15px;padding:0 3px">Ã—</button>`:''}</div>`).join('')}</div>
        <button id="add-edit-oc" style="background:none;border:1px dashed #D1D9E6;border-radius:5px;padding:6px;cursor:pointer;font-size:12px;color:var(--tx2);font-family:'Source Sans 3',sans-serif;width:100%;margin-top:5px">+ Add outcome</button></div>
      <div><label style="font-size:11px;color:var(--tx2);margin-bottom:4px;display:block;font-weight:600">End Date</label><input type="date" id="ef-end" value="${ef.end}"></div>
      <button class="btn btn-t" id="save-edit-btn" style="width:100%;padding:11px;font-size:13.5px">Save Changes</button>
    </div></div></div>`;
  document.getElementById('app').insertAdjacentHTML('beforeend',html);
  document.getElementById('close-edit').onclick=()=>{S.editing=null;render()};
  document.getElementById('edit-overlay').onclick=e=>{if(e.target===e.currentTarget){S.editing=null;render()}};
  document.getElementById('ef-title').oninput=e=>{S.editForm.title=e.target.value};
  document.getElementById('ef-desc').oninput=e=>{S.editForm.desc=e.target.value};
  document.getElementById('ef-end').onchange=e=>{S.editForm.end=e.target.value};
  document.querySelectorAll('.edit-outcome').forEach(el=>{el.oninput=e=>{S.editForm.outcomes[parseInt(el.dataset.idx)]=e.target.value}});
  document.querySelectorAll('.rm-edit-oc').forEach(el=>{el.onclick=()=>{S.editForm.outcomes.splice(parseInt(el.dataset.idx),1);render()}});
  document.getElementById('add-edit-oc').onclick=()=>{S.editForm.outcomes.push('');render()};
  document.getElementById('save-edit-btn').onclick=saveEdit;
}

function mountResolve(){
  const m=S.resolving;
  let html=`<div class="overlay" id="resolve-overlay"><div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px"><h2 style="font-size:16.5px;font-weight:700">ğŸ Resolve Market</h2><button class="xbtn" id="close-resolve">Ã—</button></div>
    <p style="font-size:13px;font-weight:600;margin-bottom:4px">${m.title}</p>
    <p style="font-size:12.5px;color:var(--tx3);margin-bottom:18px;line-height:1.5">Select the winner. <strong>Permanent.</strong> Winners get $1/share, losers $0.</p>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:18px">
      ${m.outcomes.map((o,j)=>`<button class="resolve-btn" data-idx="${j}" style="display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-radius:8px;border:2px solid var(--bdr);background:#F8FAFC;cursor:pointer;font-family:'Source Sans 3',sans-serif;font-size:14px;font-weight:600;color:var(--tx);transition:all .12s"><span>${o.label}</span><span class="m" style="font-size:14px;color:${T}">${Math.round(o.price*100)}Â¢</span></button>`).join('')}
    </div>
    <div style="border-top:1px solid var(--bdr);padding-top:14px;display:flex;gap:8px">
      <button class="btn" id="cancel-market-btn" style="background:#FEF3C7;color:#92400E;flex:1;font-size:12px">Cancel (refund all)</button>
      <button class="btn" id="delete-market-btn" style="background:rgba(239,68,68,.08);color:${RD};flex:1;font-size:12px">Delete Market</button>
    </div></div></div>`;
  document.getElementById('app').insertAdjacentHTML('beforeend',html);
  document.getElementById('close-resolve').onclick=()=>{S.resolving=null;render()};
  document.getElementById('resolve-overlay').onclick=e=>{if(e.target===e.currentTarget){S.resolving=null;render()}};
  document.querySelectorAll('.resolve-btn').forEach(el=>{
    el.onmouseenter=()=>{el.style.borderColor=GN;el.style.background='#F0FDF4'};
    el.onmouseleave=()=>{el.style.borderColor='var(--bdr)';el.style.background='#F8FAFC'};
    el.onclick=()=>{if(confirm('Resolve: "'+m.outcomes[parseInt(el.dataset.idx)].label+'" wins?'))resolveMarket(parseInt(el.dataset.idx))}});
  document.getElementById('cancel-market-btn').onclick=()=>{if(confirm('Cancel and refund all?'))cancelMarket()};
  document.getElementById('delete-market-btn').onclick=()=>{if(confirm('Permanently delete?'))deleteMarket(m.id)};
}

function bindEvents(){
  document.querySelectorAll('.tab').forEach(el=>{el.onclick=()=>{S.view=el.dataset.view;render()}});
  document.getElementById('logo-click')?.addEventListener('click',()=>{S.view='markets';render()});
  document.getElementById('new-market-btn')?.addEventListener('click',()=>{S.creating=true;render()});
  document.getElementById('first-market-btn')?.addEventListener('click',()=>{S.creating=true;render()});
  document.getElementById('search-input')?.addEventListener('input',e=>{S.q=e.target.value;render()});
  document.getElementById('sort-select')?.addEventListener('change',e=>{S.sort=e.target.value;render()});
  document.querySelectorAll('.cat-btn').forEach(el=>{el.onclick=()=>{S.cat=el.dataset.cat;render()}});
  document.querySelectorAll('[data-market-id]').forEach(el=>{
    el.onclick=()=>{const m=S.markets.find(x=>x.id===parseInt(el.dataset.marketId));if(m){S.sel=m;S.selOc=0;S.side='yes';S.amt='';render()}}});

  // View user profile (available everywhere)
  document.querySelectorAll('.view-user-btn').forEach(el=>{
    el.onclick=e=>{
      e.stopPropagation();
      S.viewingUser=el.dataset.user;render();
    };
  });

  // Admin panel events
  document.querySelectorAll('.add-funds-btn').forEach(el=>{
    el.onclick=e=>{e.stopPropagation();S.addFundsUser=el.dataset.user;S.addFundsAmt='';render()}});
  document.querySelectorAll('.admin-delete-btn').forEach(el=>{
    el.onclick=e=>{e.stopPropagation();adminDeleteUser(el.dataset.user)}});
  document.getElementById('admin-add-user-btn')?.addEventListener('click',()=>{S.addingUser=true;render()});

  // Admin: editable balance (click to edit)
  document.querySelectorAll('.admin-balance-edit').forEach(el=>{
    el.onclick=e=>{
      e.stopPropagation();
      S.editingBalance=el.dataset.user;
      S.editBalanceVal=el.textContent.replace('$','').replace(/,/g,'');
      render();
      // Focus the input after render
      setTimeout(()=>{
        const inp=document.querySelector(`.admin-balance-input[data-user="${el.dataset.user}"]`);
        if(inp){inp.focus();inp.select()}
      },50);
    };
  });
  // Admin: balance input handlers
  document.querySelectorAll('.admin-balance-input').forEach(el=>{
    el.onkeydown=e=>{
      if(e.key==='Enter'){adminSetBalance(el.dataset.user,el.value)}
      if(e.key==='Escape'){S.editingBalance=null;render()}
    };
    el.onblur=()=>{adminSetBalance(el.dataset.user,el.value)};
  });

  if(document.getElementById('add-funds-amount'))
    document.getElementById('add-funds-amount').addEventListener('input',e=>{S.addFundsAmt=e.target.value});
  if(document.getElementById('add-funds-btn'))
    document.getElementById('add-funds-btn').onclick=adminAddFunds;
  if(document.getElementById('cancel-funds-btn'))
    document.getElementById('cancel-funds-btn').onclick=()=>{S.addFundsUser=null;render()};
}

// Start
initActivityLog();
init();
setTimeout(()=>{if(S.name)checkPayouts()},2000);
</script>
</body>
</html>
